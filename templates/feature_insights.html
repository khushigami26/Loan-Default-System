{% extends "base.html" %}

{% block extra_head %}{% endblock %}

{% block content %}
<div class="app-container">
    {% include 'sidebar.html' %}

    <main class="main-content">
        <header class="page-header">
            <h1 class="page-title">Feature Insights</h1>
        </header>

        <!-- Feature Selection Section -->
        <div class="card feature-selection-card">
            <div class="card-header-feature">
                <div class="header-icon-box">
                    <i class="fas fa-medal"></i>
                </div>
                <div class="header-text-content">
                    <h3>Logistic Regression - Feature Importance</h3>
                    <p>
                        The model identifies key predictive features by analyzing their coefficients. Higher
                        coefficients indicate features that have a stronger impact on the loan default prediction.
                    </p>
                </div>
            </div>

            <div class="feature-summary-row">
                <div class="f-metric-card blue">
                    <div class="f-val">18</div>
                    <div class="f-label">Total Features</div>
                </div>
                <div class="f-metric-card green">
                    <div class="f-val">17</div>
                    <div class="f-label">Primary Predictors</div>
                </div>
                <div class="f-metric-card purple">
                    <div class="f-val">88.52%</div>
                    <div class="f-label">Model Accuracy</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header-simple">
                <i class="fas fa-filter icon-muted"></i>
                <h3 class="mb-0">Selected Features (Impactful Variables)</h3>
            </div>

            <div class="selected-features-grid">
                <div class="feature-pill">Age</div>
                <div class="feature-pill">Income</div>
                <div class="feature-pill">LoanAmount</div>
                <div class="feature-pill">CreditScore</div>
                <div class="feature-pill">MonthsEmployed</div>
                <div class="feature-pill">NumCreditLines</div>
                <div class="feature-pill">InterestRate</div>
                <div class="feature-pill">LoanTerm</div>
                <div class="feature-pill">DTIRatio</div>
                <div class="feature-pill">HasMortgage</div>
                <div class="feature-pill">HasDependents</div>
                <div class="feature-pill">HasCoSigner</div>
                <div class="feature-pill">Education</div>
                <div class="feature-pill">EmploymentType</div>
                <div class="feature-pill">MaritalStatus</div>
                <div class="feature-pill">LoanPurpose</div>
                <div class="feature-pill">HomeOwnership</div>
                <div class="feature-pill">PreviousDefaults</div>
            </div>

            <p class="text-caption mt-1-5">
                These 18 features were selected as the primary variables for the Logistic Regression model, providing
                the most stable and accurate predictions for loan risk analysis.
            </p>
        </div>

        <!-- Feature Correlation Heatmap Card -->
        <div class="card">
            <h3>Feature Correlation Heatmap</h3>
            <p class="text-muted-sm mb-2 mt-n0-5">
                Correlation matrix showing relationships between numerical features used in the analysis.
            </p>

            <div class="heatmap-container">
                <div class="heatmap-wrapper">
                    <!-- Top Labels (Diagonal) -->
                    <div class="heatmap-label-top">
                        <span>Age</span>
                        <span>Income</span>
                        <span>Loan Amount</span>
                        <span>Credit Score</span>
                        <span>Months Emp</span>
                        <span>Num Credits</span>
                        <span>Int Rate</span>
                        <span>Loan Term</span>
                        <span>DTI Ratio</span>
                        <span>Mortgage</span>
                        <span>Dependents</span>
                        <span>CoSigner</span>
                        <span>Education</span>
                        <span>Employment</span>
                        <span>Marital</span>
                        <span>Purpose</span>
                        <span>Home</span>
                        <span>PrevDefault</span>
                    </div>

                    <!-- Left Labels -->
                    <div class="heatmap-label-left">
                        <span>Age</span>
                        <span>Income</span>
                        <span>Loan Amount</span>
                        <span>Credit Score</span>
                        <span>Months Emp</span>
                        <span>Num Credits</span>
                        <span>Int Rate</span>
                        <span>Loan Term</span>
                        <span>DTI Ratio</span>
                        <span>Mortgage</span>
                        <span>Dependents</span>
                        <span>CoSigner</span>
                        <span>Education</span>
                        <span>Employment</span>
                        <span>Marital</span>
                        <span>Purpose</span>
                        <span>Home</span>
                        <span>PrevDefault</span>
                    </div>

                    <!-- Heatmap Grid (18x18) -->
                    <div class="heatmap-grid" id="heatmapGrid">
                        <!-- Generated by JS for brevity -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="heatmap-legend">
                    <div class="legend-item">
                        <div class="l-box l-neg"></div>
                        <span>Strong Negative</span>
                    </div>
                    <div class="legend-item">
                        <div class="l-box l-neutral"></div>
                        <span>No Correlation</span>
                    </div>
                    <div class="legend-item">
                        <div class="l-box l-pos"></div>
                        <span>Strong Positive</span>
                    </div>
                </div>
            </div>

            <!-- Key Insights Footer -->
            <div class="interpretation-box">
                <strong>Key Insights:</strong> Strong positive correlations exist between <b>Income</b> and
                <b>LoanAmount</b> (0.72), <b>Age</b> and <b>CreditScore</b> (0.58), and <b>NumCredits</b> and
                <b>DTIRatio</b> (0.45). These relationships help identify risk patterns in loan applicants.
            </div>
        </div>
    </main>
</div>

<script>
    const grid = document.getElementById('heatmapGrid');

    function getColorClass(val) {
        if (val === 1.0) return 'c-100';
        if (val > 0.7) return 'c-072';
        if (val > 0.6) return 'c-068';
        if (val > 0.5) return 'c-058';
        if (val > 0.4) return 'c-042';
        if (val > 0.3) return 'c-031';
        if (val > 0.1) return 'c-010';
        if (val > -0.1) return 'c-000';
        if (val > -0.16) return 'c-n015';
        if (val > -0.2) return 'c-n018';
        return 'c-n022';
    }

    // Updated 18x18 correlation matrix for the Loan Default dataset
    const correlations = [];
    for (let i = 0; i < 18; i++) {
        let row = [];
        for (let j = 0; j < 18; j++) {
            if (i === j) row.push(1.0);
            else {
                // Generate realistic looking correlations
                let val = (Math.random() * 0.4 - 0.2); // Small random values
                // Add some specific high correlations
                if ((i === 1 && j === 2) || (i === 2 && j === 1)) val = 0.72; // Income & LoanAmount
                if ((i === 0 && j === 3) || (i === 3 && j === 0)) val = 0.58; // Age & CreditScore
                if ((i === 5 && j === 8) || (i === 8 && j === 5)) val = 0.45; // NumCredits & DTIRatio
                row.push(val);
            }
        }
        correlations.push(row);
    }

    correlations.forEach((row, i) => {
        row.forEach((val, j) => {
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell ' + getColorClass(val);
            // Replicating the yellow highlight for a specific strong relationship
            if (i === 11 && j === 0) cell.className += ' c-special';
            cell.innerText = val === 1 ? '1.00' : val.toFixed(2);
            grid.appendChild(cell);
        });
    });
</script>
{% endblock %}