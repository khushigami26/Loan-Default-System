{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loader-container">
        <div class="loader-spinner"></div>
        <div class="loader-text">Analyzing Risk Profile...</div>
        <div class="loader-subtext pulse">
            <i class="fas fa-shield-alt"></i> Running ML Ensembles
        </div>
    </div>
</div>

{% set is_default = 'Default' in result %}
{% set status_class = 'is-default' if is_default else 'is-approved' %}
{% set icon_class = 'fa-times-circle' if is_default else 'fa-check-circle' %}

<div id="result-content" class="app-container">
    {% include 'sidebar.html' %}

    <main class="main-content result-main">
        <div class="card result-card">
            <div class="result-icon {{ status_class }}">
                <i class="fas {{ icon_class }}"></i>
            </div>

            <h2 class="result-title">Assessment Result</h2>

            <div class="result-display {{ status_class }}">
                {{ result }}
            </div>

            <p class="result-meta">
                <i class="fas fa-microchip"></i> Prediction Generated by <strong>{{ model_name }}</strong> algorithm
            </p>

            <!-- AI Insights Section -->
            <div class="insights-card">
                <div class="insights-title">
                    <i class="fas fa-brain" style="color: #6366f1;"></i> AI Risk Factors & Insights
                </div>

                {% if features %}
                {% if features['CreditScore'] > 700 %}
                <div class="insight-item">
                    <div class="insight-icon positive"><i class="fas fa-check-circle"></i></div>
                    <div class="insight-content">
                        <h4>Excellent Credit Score</h4>
                        <p>A credit score of {{ features['CreditScore'] }} significantly minimizes default probability.
                        </p>
                    </div>
                </div>
                {% elif features['CreditScore'] < 600 %} <div class="insight-item">
                    <div class="insight-icon negative"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="insight-content">
                        <h4>Poor Credit Score</h4>
                        <p>A credit score of {{ features['CreditScore'] }} is below average, increasing risk.</p>
                    </div>
            </div>
            {% else %}
            <div class="insight-item">
                <div class="insight-icon neutral"><i class="fas fa-info-circle"></i></div>
                <div class="insight-content">
                    <h4>Fair Credit Score</h4>
                    <p>The credit score of {{ features['CreditScore'] }} is acceptable but could be improved.</p>
                </div>
            </div>
            {% endif %}

            {% if features['DTIRatio'] > 0.4 %}
            <div class="insight-item">
                <div class="insight-icon negative"><i class="fas fa-exclamation-circle"></i></div>
                <div class="insight-content">
                    <h4>High Debt-to-Income Ratio</h4>
                    <p>DTI of {{ (features['DTIRatio']*100)|round(1) }}% indicates high relative debt.</p>
                </div>
            </div>
            {% else %}
            <div class="insight-item">
                <div class="insight-icon positive"><i class="fas fa-check-circle"></i></div>
                <div class="insight-content">
                    <h4>Healthy DTI Ratio</h4>
                    <p>DTI of {{ (features['DTIRatio']*100)|round(1) }}% showcases good budget management.</p>
                </div>
            </div>
            {% endif %}

            {% if features['Income'] > 80000 %}
            <div class="insight-item">
                <div class="insight-icon positive"><i class="fas fa-check-circle"></i></div>
                <div class="insight-content">
                    <h4>Strong Annual Income</h4>
                    <p>Income of ₹{{ features['Income'] }} provides solid security.</p>
                </div>
            </div>
            {% elif features['Income'] < 40000 %} <div class="insight-item">
                <div class="insight-icon negative"><i class="fas fa-exclamation-circle"></i></div>
                <div class="insight-content">
                    <h4>Low Annual Income</h4>
                    <p>Income of ₹{{ features['Income'] }} may struggle with repayments.</p>
                </div>
        </div>
        {% endif %}
        {% endif %}
</div>

<div class="result-actions">
    <a href="/loan" class="btn btn-primary">
        <i class="fas fa-redo"></i> Check Another Profile
    </a>
    <a href="{{ url_for('main.loan_default_dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-chart-pie"></i> View Dashboard
    </a>
</div>
</div>
</main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messages = [
            "Parsing financial history...",
            "Validating credit utilization...",
            "Computing DTI thresholds...",
            "Running ensemble inference...",
            "Finalizing risk bounds..."
        ];

        const subtext = document.querySelector('.loader-subtext');
        let index = 0;

        const textInterval = setInterval(() => {
            if (index < messages.length) {
                subtext.innerHTML = `<i class="fas fa-check-circle" style="color: #6366f1;"></i> ${messages[index]}`;
                index++;
            } else {
                clearInterval(textInterval);
            }
        }, 900); // Updated interval for 5s total wait

        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            const content = document.getElementById('result-content');

            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                content.classList.add('show');
            }, 500);
        }, 5000); // 5s wait time
    });
</script>
{% endblock %}